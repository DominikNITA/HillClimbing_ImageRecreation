@using System.Drawing

<div>
    <Title>Algorithm parameters</Title>
    <Form Model="@_parametersModel" OnFinish="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <Divider Orientation="left" Style="font-weight:bold">Used shapes</Divider>
        <EnumCheckBoxGroup TEnum="Shape" AllInitiallySelected="true" OnChangeCallback="@((x) => _parametersModel.Shapes = x)"></EnumCheckBoxGroup>

        <Divider Orientation="left" Style="font-weight:bold">Shape size limits[px]: [@_parametersModel.MinShapeSize, @_parametersModel.MaxShapeSize]</Divider>
        <Slider @bind-Value="_parametersModel.ShapeSizeLimits"
                TValue="(double, double)"
                Min="1"
                Max="GetMaxShapeLimit()">
        </Slider>

        <Divider Orientation="left" Style="font-weight:bold">Starting Background Color</Divider>
        <ColorPicker InitialBackgroundAlpha="50" InitialBackgroundColor="#00ff00" OnChangeCallback=@((newColor) => {_parametersModel.BackgroundBaseColorString = newColor;})></ColorPicker>

        <Divider Orientation="left" Style="font-weight:bold">Max iterations</Divider>
        <AntDesign.InputNumber TValue="int" Min="100" Max="20000" Step="100" Format="#####" @bind-Value=@_parametersModel.MaxIterations></AntDesign.InputNumber>

        <Divider Orientation="left" Style="font-weight:bold">Other settings</Divider>
        <div>
            <Checkbox @bind-Checked="@_parametersModel.AllowRotation" Disabled>Allow rotation (WIP)</Checkbox>
        </div>
        <div>
            <Checkbox @bind-Checked="@_parametersModel.AllowAlpha">Allow Alpha</Checkbox>
        </div>
        <div>
            <Checkbox Disabled>Use Color Dictionary (WIP)</Checkbox>
        </div>

        <Divider></Divider>
        <GridRow Justify="center">
            <GridCol>
                <Button HtmlType="submit" @onclick=@(() => System.Console.WriteLine(_parametersModel.PropertiesToString()))>Start!</Button>
            </GridCol>
        </GridRow>
    </Form>
</div>
@code {
    private AlgorithmParameters _parametersModel = new();
    private string? _previousBackgroundColorString;

    [Parameter]
    public EventCallback<AlgorithmParameters> OnAlgorithmParametersSet { get; set; }

    [Parameter]
    public AnalysisResult? Analysis { get; set; }

    protected override void OnParametersSet()
    {
        _parametersModel.ShapeSizeLimits = (1, GetMaxShapeLimit() / 2);
        _parametersModel.BackgroundBaseColorString = "#e1d9d9ff";
        _parametersModel.MaxIterations = 1000;
        _parametersModel.Shapes = new List<Shape>() { Shape.Ellipse, Shape.Rectangle, Shape.Triangle };
        _parametersModel.ImagePresentationInterval = 10;
        _parametersModel.UseBackgroundColorChance = 0.025;
    }

    private int GetMaxShapeLimit()
    {
        return Math.Max(Analysis?.Width ?? 1, Analysis?.Height ?? 1);
    }

    private async void HandleValidSubmit()
    {
        System.Console.WriteLine(_parametersModel.PropertiesToString());
        await OnAlgorithmParametersSet.InvokeAsync(_parametersModel);
    }

    public void OnColorChanged(ChangeEventArgs e)
    {
        System.Console.WriteLine(e.Value?.ToString());
        _parametersModel.BackgroundBaseColorString = e.Value?.ToString() + "ff";
    }

    private void onUseTransparentColorChange(ChangeEventArgs args)
    {
        if ((bool)(args.Value ?? false))
        {
            _previousBackgroundColorString = _parametersModel.BackgroundBaseColorString;
            _parametersModel.BackgroundBaseColorString = "#00000000";
        }
        else
        {
            _parametersModel.BackgroundBaseColorString = _previousBackgroundColorString ?? string.Empty;
            _previousBackgroundColorString = null;
        }
    }
}
